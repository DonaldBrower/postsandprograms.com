
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap"
    rel="stylesheet">
  <title>text processing challenge, the number of atoms.</title>
  <link rel="stylesheet" href="/css/parsed.style.css">
  <link rel="stylesheet" href="/css/prism.css">

</head>

<body>
  <div class="post">
    <nav>
      <a href="/">&#8592; Home</a>
    </nav>
    <article class="text"><h2>text processing challenge, the number of atoms.</h2>
<p><a href="https://github.com/DonaldBrower/practice-questions/blob/master/number-of-atoms/3.number-of-atoms.js">The code on GitHub</a></p>
<p>Here is a text processing challenge that we'll solve in JS. The Number of Atoms has us take an unsimplified chemical formula expression, and reduce it so all multiplicity groups are distributed, and repeat atoms in the formula are combined. See the following examples:</p>
<pre class="language-js"><code class="language-js"><span class="token function">solve</span><span class="token punctuation">(</span><span class="token string">"Mg2(OH)2"</span><span class="token punctuation">)</span>  <span class="token comment">// H2O2Mg2</span><br><br><span class="token function">solve</span><span class="token punctuation">(</span><span class="token string">"HO2"</span><span class="token punctuation">)</span>  <span class="token comment">// H2O2</span><br><br><span class="token function">solve</span><span class="token punctuation">(</span><span class="token string">"Au(OKIP33)2"</span><span class="token punctuation">)</span>  <span class="token comment">// AuK66I66O66P66</span></code></pre>
<p>We'll use pattern matching, iteration, and variable assignment to achieve the answer. There will also be tuples. The following JSON output is from about halfway through the program's construction. From this block of data, we have everything that we need to know in order to expand all of the content between grouping symbols and coeficents before any other operations.</p>
<p>We have a set of tuples [n, m] where n is the parsed atom &quot;Mg&quot; for example, and M is the current number of that atom after any inner coeficent. we can now join the tuples together, and replace the section of the formula string where it came from with the new content, and once that is done from right to left, the string will be ready to be expanded into groups and multiplied by the group multipliers.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// input formula: MgA4(OgHKLMg(HOg3)2(KP9))</span><br><span class="token punctuation">[</span><br>  <span class="token punctuation">{</span><br>    <span class="token string">"content"</span><span class="token operator">:</span> <span class="token string">"MgA"</span><span class="token punctuation">,</span><br>    <span class="token string">"idxFirst"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>    <span class="token string">"coefficient"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span><br>    <span class="token string">"wholegroupIdxLast"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><br>    <span class="token string">"tokens"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token punctuation">[</span><br>        <span class="token string">"Mg"</span><span class="token punctuation">,</span><br>        <span class="token number">4</span><br>      <span class="token punctuation">]</span><span class="token punctuation">,</span><br>      <span class="token punctuation">[</span><br>        <span class="token string">"A"</span><span class="token punctuation">,</span><br>        <span class="token number">4</span><br>      <span class="token punctuation">]</span><br>    <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token string">"content"</span><span class="token operator">:</span> <span class="token string">"OgHKLMg"</span><span class="token punctuation">,</span><br>    <span class="token string">"idxFirst"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span><br>    <span class="token string">"coefficient"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>    <span class="token string">"wholegroupIdxLast"</span><span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span><br>    <span class="token string">"tokens"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token punctuation">[</span><br>        <span class="token string">"Og"</span><span class="token punctuation">,</span><br>        <span class="token number">1</span><br>      <span class="token punctuation">]</span><span class="token punctuation">,</span><br>      <span class="token punctuation">[</span><br>        <span class="token string">"H"</span><span class="token punctuation">,</span><br>        <span class="token number">1</span><br>      <span class="token punctuation">]</span><span class="token punctuation">,</span><br>      <span class="token punctuation">[</span><br>        <span class="token string">"K"</span><span class="token punctuation">,</span><br>        <span class="token number">1</span><br>      <span class="token punctuation">]</span><span class="token punctuation">,</span><br>      <span class="token punctuation">[</span><br>        <span class="token string">"L"</span><span class="token punctuation">,</span><br>        <span class="token number">1</span><br>      <span class="token punctuation">]</span><span class="token punctuation">,</span><br>      <span class="token punctuation">[</span><br>        <span class="token string">"Mg"</span><span class="token punctuation">,</span><br>        <span class="token number">1</span><br>      <span class="token punctuation">]</span><br>    <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token string">"content"</span><span class="token operator">:</span> <span class="token string">"HOg"</span><span class="token punctuation">,</span><br>    <span class="token string">"idxFirst"</span><span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">,</span><br>    <span class="token string">"coefficient"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><br>    <span class="token string">"wholegroupIdxLast"</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span><br>    <span class="token string">"tokens"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token punctuation">[</span><br>        <span class="token string">"H"</span><span class="token punctuation">,</span><br>        <span class="token number">3</span><br>      <span class="token punctuation">]</span><span class="token punctuation">,</span><br>      <span class="token punctuation">[</span><br>        <span class="token string">"Og"</span><span class="token punctuation">,</span><br>        <span class="token number">3</span><br>      <span class="token punctuation">]</span><br>    <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token string">"content"</span><span class="token operator">:</span> <span class="token string">"KP"</span><span class="token punctuation">,</span><br>    <span class="token string">"idxFirst"</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span><br>    <span class="token string">"coefficient"</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span><br>    <span class="token string">"wholegroupIdxLast"</span><span class="token operator">:</span> <span class="token number">22</span><span class="token punctuation">,</span><br>    <span class="token string">"tokens"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>      <span class="token punctuation">[</span><br>        <span class="token string">"K"</span><span class="token punctuation">,</span><br>        <span class="token number">9</span><br>      <span class="token punctuation">]</span><span class="token punctuation">,</span><br>      <span class="token punctuation">[</span><br>        <span class="token string">"P"</span><span class="token punctuation">,</span><br>        <span class="token number">9</span><br>      <span class="token punctuation">]</span><br>    <span class="token punctuation">]</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">]</span></code></pre>
<p>This post will be about the steps taken to get to this point, and the steps to finish the solution.</p>
<p>Here's what we get once we're done processing this array of group objects:</p>
<p><code>MgA4(Og1H1K1L1Mg1(H3Og3)2(K9P9))</code></p>
<p>Here is the final code:</p>
<pre class="language-js"><code class="language-js"><span class="token string">"use strict"</span><span class="token punctuation">;</span><br><span class="token keyword">var</span> <span class="token punctuation">{</span> isCap<span class="token punctuation">,</span> isNumber<span class="token punctuation">,</span> replace<span class="token punctuation">,</span> tupleJoin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./utils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">var</span> <span class="token punctuation">{</span> Group <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./Group.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">/* main loop */</span><br><span class="token function">main</span><span class="token punctuation">(</span><span class="token string">"MgA4(OgHKLMg(HOg3)2(KP9))"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// ******************************************************************************************</span><br><span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token parameter">formula</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> innerGroupContent <span class="token operator">=</span> <span class="token function">innerGroups</span><span class="token punctuation">(</span>formula<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> innerGroupContentExpanded <span class="token operator">=</span> <span class="token function">expandInnerGroups</span><span class="token punctuation">(</span>innerGroupContent<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> formulaInnerGroupsExpanded <span class="token operator">=</span> <span class="token function">replaceGroupsInString</span><span class="token punctuation">(</span><br>    formula<span class="token punctuation">,</span><br>    innerGroupContentExpanded<br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> fullyExpandedString <span class="token operator">=</span> <span class="token function">recursivelyExpandDeepestGroups</span><span class="token punctuation">(</span><br>    formulaInnerGroupsExpanded<br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> output <span class="token operator">=</span> <span class="token function">reduceFinalTuples</span><span class="token punctuation">(</span><br>    <span class="token function">tokenizeAtoms</span><span class="token punctuation">(</span>fullyExpandedString<span class="token punctuation">,</span> stateMachine<span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"><br>    Formula: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>formula<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"><br>    Reduced: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"><br>  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">//*****************************************************************************</span><br><span class="token comment">/**<br> *<br> * @param {*} formula<br> * @returns {Group[]} returns a collection of Group objects, created from the<br> *  match results of applying the atomsInGroups regular expression to the formula<br> */</span><br><span class="token keyword">function</span> <span class="token function">innerGroups</span><span class="token punctuation">(</span><span class="token parameter">formula</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> atomsInGroups <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">([A-Za-z]+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">...</span>formula<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span>atomsInGroups<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">groupFromRgx</span><span class="token punctuation">(</span><span class="token parameter">group</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Group</span><span class="token punctuation">(</span><br>      group<span class="token punctuation">.</span>input<span class="token punctuation">,</span><br>      group<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>      group<span class="token punctuation">.</span>index<span class="token punctuation">,</span><br>      group<span class="token punctuation">.</span>index <span class="token operator">+</span> group<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/**<br> * use the output of innerGroups(formula) to simplify the expressions within each group.<br> * @param {*} formula<br> * @param {*} innerGroups<br> */</span><br><span class="token keyword">function</span> <span class="token function">expandInnerGroups</span><span class="token punctuation">(</span><span class="token parameter">innerGroups</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> innerGroups<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>innerGroups<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">var</span> <span class="token punctuation">{</span> content<span class="token punctuation">,</span> coefficient <span class="token punctuation">}</span> <span class="token operator">=</span> innerGroups<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>      innerGroups<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tokens <span class="token operator">=</span> <span class="token function">tokenizeAtoms</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> stateMachine<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token keyword">var</span> <span class="token punctuation">{</span> tokens <span class="token punctuation">}</span> <span class="token operator">=</span> innerGroups<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>coefficient <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">distributeOverAtoms</span><span class="token punctuation">(</span>coefficient<span class="token punctuation">,</span> tokens<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">return</span> innerGroups<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">recursivelyExpandDeepestGroups</span><span class="token punctuation">(</span><span class="token parameter">formula</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// formula doesn't contain any parens, then we've hit our base case)</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>formula<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\(|\)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> formula<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// extract deepest group, expand, and recurse with the expanded string as the</span><br>  <span class="token comment">//  argument</span><br><br>  <span class="token keyword">var</span> parenGroupContent <span class="token operator">=</span> <span class="token function">deepestGroups</span><span class="token punctuation">(</span>formula<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> expandedParenGroups <span class="token operator">=</span> parenGroupContent<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">expand</span><span class="token punctuation">(</span><span class="token parameter">group</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    group<span class="token punctuation">.</span>tokens <span class="token operator">=</span> <span class="token function">tokenizeAtoms</span><span class="token punctuation">(</span><br>      group<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\(|\)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      stateMachine<br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>group<span class="token punctuation">.</span>coefficient <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">distributeOverAtoms</span><span class="token punctuation">(</span>group<span class="token punctuation">.</span>coefficient<span class="token punctuation">,</span> group<span class="token punctuation">.</span>tokens<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      <span class="token function">distributeOverAtoms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> group<span class="token punctuation">.</span>tokens<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> group<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> formulaParenGroupsExpanded <span class="token operator">=</span> <span class="token function">replaceGroupsInString</span><span class="token punctuation">(</span><br>    formula<span class="token punctuation">,</span><br>    expandedParenGroups<br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token function">recursivelyExpandDeepestGroups</span><span class="token punctuation">(</span>formulaParenGroupsExpanded<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/**<br> * @param {*} formula<br> * @returns {Group[]} - returns a collection of Group objects, created<br> *  from the match results of applying a regexp to the formula<br> */</span><br><span class="token keyword">function</span> <span class="token function">deepestGroups</span><span class="token punctuation">(</span><span class="token parameter">formula</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> deepestGroups <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\([^\(]+?\))</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">...</span>formula<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span>deepestGroups<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">groupFromRgx</span><span class="token punctuation">(</span><span class="token parameter">group</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Group</span><span class="token punctuation">(</span><br>      group<span class="token punctuation">.</span>input<span class="token punctuation">,</span><br>      group<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>      group<span class="token punctuation">.</span>index<span class="token punctuation">,</span><br>      group<span class="token punctuation">.</span>index <span class="token operator">+</span> group<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">reduceFinalTuples</span><span class="token punctuation">(</span><span class="token parameter">tuples</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> atomsToQty <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>  tuples<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">processTuple</span><span class="token punctuation">(</span><span class="token parameter">tuple<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>atomsToQty<span class="token punctuation">[</span>tuple<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      atomsToQty<span class="token punctuation">[</span>tuple<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> tuple<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>atomsToQty<span class="token punctuation">[</span>tuple<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      atomsToQty<span class="token punctuation">[</span>tuple<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+=</span> tuple<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> reducedTuples <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> atomsToQty<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    reducedTuples<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>key<span class="token punctuation">,</span> atomsToQty<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">var</span> sortedTuples <span class="token operator">=</span> reducedTuples<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token function">tupleJoin</span><span class="token punctuation">(</span>sortedTuples<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token comment">// ******************************************************************************************</span><br><br><span class="token comment">/**<br> *<br> * @param {*} target<br> * @param {*} groups<br> * @returns<br> */</span><br><span class="token keyword">function</span> <span class="token function">replaceGroupsInString</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> groups</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> updatingTarget <span class="token operator">=</span> target<span class="token punctuation">;</span><br><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> groups<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> i<span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> <span class="token punctuation">{</span> idxFirst<span class="token punctuation">,</span> wholegroupIdxLast<span class="token punctuation">,</span> tokens <span class="token punctuation">}</span> <span class="token operator">=</span> groups<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">var</span> expandedString <span class="token operator">=</span> <span class="token function">tupleJoin</span><span class="token punctuation">(</span>tokens<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    updatingTarget <span class="token operator">=</span> <span class="token function">replace</span><span class="token punctuation">(</span><br>      updatingTarget<span class="token punctuation">,</span><br>      idxFirst<span class="token punctuation">,</span><br>      wholegroupIdxLast<span class="token punctuation">,</span><br>      expandedString<br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">return</span> updatingTarget<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/**<br> *<br> * @param {*} coeffecient<br> * @param {*} atoms<br> */</span><br><span class="token keyword">function</span> <span class="token function">distributeOverAtoms</span><span class="token punctuation">(</span><span class="token parameter">coeffecient<span class="token punctuation">,</span> atoms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  atoms<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">distributeOverAtom</span><span class="token punctuation">(</span><span class="token parameter">atom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    atom<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> atom<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> coeffecient<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/*<br> * atoms are tokenized while recursivly moving through the inside all of the<br> * grouped sections of the forumla, as well as after reducing the tuples in a map<br> *<br> * uses state machine, returns an array of Tuples:<br> * [atomName: str, atomQty: num]<br> */</span><br><span class="token keyword">function</span> <span class="token function">tokenizeAtoms</span><span class="token punctuation">(</span><span class="token parameter">atomString<span class="token punctuation">,</span> stateMachine</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">var</span> atomChars <span class="token operator">=</span> atomString<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">var</span> state <span class="token operator">=</span> <span class="token punctuation">{</span><br>    buffer<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span><br>    quantString<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span><br>    atoms<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token function">stateMachine</span><span class="token punctuation">(</span>atomChars<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> state<span class="token punctuation">.</span>atoms<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/* <br>  tokenize("MgOg2") should return [Mg, 2], [Og, 2]<br>  <br>  if parenthesis are used, then only the atoms inside get the coeffcient, eg: "Mg(OH)2" [Mg, 1], [O, 2], [H, 2] <br><br>  distribute the atom string coeffecients before handling any parenthesis groups, so when the distributing the group coefeccient  happens, it can be applied to all the tuples, and then can be simply reduced  <br>*/</span><br><span class="token keyword">function</span> <span class="token function">stateMachine</span><span class="token punctuation">(</span><span class="token parameter">atomCharacters<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  atomCharacters<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">procesChar</span><span class="token punctuation">(</span><span class="token parameter">char<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> nextChar <span class="token operator">=</span> atomCharacters<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// is this the last character for this atom/number?</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCap</span><span class="token punctuation">(</span>nextChar<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token operator">||</span> nextChar <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNumber</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        state<span class="token punctuation">.</span>buffer <span class="token operator">+=</span> char<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNumber</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        state<span class="token punctuation">.</span>quantString <span class="token operator">+=</span> char<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span>quantString<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        state<span class="token punctuation">.</span>quantString <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br><br>      state<span class="token punctuation">.</span>atoms<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>state<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> <span class="token operator">+</span>state<span class="token punctuation">.</span>quantString<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      state<span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span><br>      state<span class="token punctuation">.</span>quantString <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// are there more characters in this atom/number?</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCap</span><span class="token punctuation">(</span>nextChar<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNumber</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        state<span class="token punctuation">.</span>buffer <span class="token operator">+=</span> char<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNumber</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        state<span class="token punctuation">.</span>quantString <span class="token operator">+=</span> char<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>Utils.js:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">isCap</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">+</span>str<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>str <span class="token operator">===</span> str<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">isNumber</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">+</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">replace</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">string<span class="token punctuation">,</span> open<span class="token punctuation">,</span> close<span class="token punctuation">,</span> replaceStr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// replace an index range, inclusive of the start and end indexes</span><br>  <span class="token keyword">let</span> charArr <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  charArr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>open<span class="token punctuation">,</span> close <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">-</span> open<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">let</span> replaceStrCharArray <span class="token operator">=</span> replaceStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">let</span> frontArray <span class="token operator">=</span> charArr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> open<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">let</span> joinedArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>frontArray<span class="token punctuation">,</span> replaceStrCharArray<span class="token punctuation">,</span> charArr<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> joinedArray<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">tupleJoin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">tuplesArr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// returns</span><br>  <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span><br>  tuplesArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">tuple</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    str <span class="token operator">+=</span> tuple<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> str<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">extractAllNumbersAfterIdx</span><span class="token punctuation">(</span><span class="token parameter">formula<span class="token punctuation">,</span> contentIdxLast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> numberHasEnded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>    i <span class="token operator">=</span> contentIdxLast<span class="token punctuation">,</span><br>    output <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>numberHasEnded<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">isInteger</span><span class="token punctuation">(</span><span class="token operator">+</span>formula<span class="token punctuation">[</span><span class="token operator">++</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      output <span class="token operator">+=</span> formula<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      numberHasEnded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">return</span> <span class="token operator">+</span>output<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><br>  isCap<span class="token punctuation">,</span><br>  isNumber<span class="token punctuation">,</span><br>  replace<span class="token punctuation">,</span><br>  tupleJoin<span class="token punctuation">,</span><br>  extractAllNumbersAfterIdx<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>Groups.js:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> extractAllNumbersAfterIdx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./utils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">/* properties from regular expression exec output are mapped to Group object */</span><br><span class="token keyword">class</span> <span class="token class-name">Group</span> <span class="token punctuation">{</span><br>  <span class="token comment">/**<br>   * regexRes = an object that represents the returned value of a call to<br>   *  regex.exec(str)<br>   *<br>   * @param {string} formula - from regexRes.input,, the whole formula, needed so<br>   *  that the coeffcient, which will be outside of the group, can be captured<br>   *  and assigned to this.coeffecient<br>   *<br>   * @param {string} content - from regexRes[0],, regexRes is an array with some<br>   *  extra properties, taking the zeroth index will give you the matched text<br>   *<br>   * @param {number} idxFirst - regexRes.index,, index of where the first char<br>   *  in regexRes[0] matches in regexRes.input<br>   *<br>   * @param {nummber} contentIdxLast - regexRes.index + regexRes[0].lenghth - 1,,<br>   *  index of the last char in regexRes[0] in regexRes.input<br>   */</span><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">formula<span class="token punctuation">,</span> content<span class="token punctuation">,</span> idxFirst<span class="token punctuation">,</span> contentIdxLast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> content<span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>idxFirst <span class="token operator">=</span> idxFirst<span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>coefficient <span class="token operator">=</span> <span class="token function">extractAllNumbersAfterIdx</span><span class="token punctuation">(</span>formula<span class="token punctuation">,</span> contentIdxLast<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>wholegroupIdxLast <span class="token operator">=</span><br>      idxFirst <span class="token operator">+</span><br>      content<span class="token punctuation">.</span>length <span class="token operator">+</span><br>      <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>coefficient <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>coefficient<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> Group <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</article>
  </div>
  <script src="./../vendor/js/prism.js"></script>
</body>

</html>
